# Git Setup for Native Files

Guide for managing native iOS and Android files in git with Expo projects.

---

## Overview

Expo projects typically ignore the entire `/ios` and `/android` folders since they're generated by `npx expo prebuild`. However, for Firebase push notifications, we need to keep specific files that contain custom configurations.

---

## What We Keep in Git

### iOS Files

```
ios/
├── Podfile                      ✅ KEEP (has use_modular_headers!)
├── Podfile.properties.json      ✅ KEEP (Podfile configuration)
└── [everything else ignored]    ❌ IGNORE
```

**Why keep these:**
- `Podfile` contains `use_modular_headers!` which is required for Firebase
- `Podfile.properties.json` contains build configuration
- These files won't be regenerated correctly by `expo prebuild`

### Android Files

```
android/
├── app/
│   └── src/
│       ├── main/
│       │   └── AndroidManifest.xml  ✅ KEEP (has notification permissions)
│       └── debug/
│           └── AndroidManifest.xml  ✅ KEEP (debug configuration)
└── [everything else ignored]        ❌ IGNORE
```

**Why keep these:**
- AndroidManifest.xml files can have custom configurations
- Though mostly generated from `app.config.js`, good to track

---

## .gitignore Configuration

### Current Setup

```gitignore
# generated native folders
/android/*
# But keep important Android configuration files
!/android/app
/android/app/*
!/android/app/src
/android/app/src/*
!/android/app/src/main
/android/app/src/main/*
!/android/app/src/main/AndroidManifest.xml
!/android/app/src/debug
/android/app/src/debug/*
!/android/app/src/debug/AndroidManifest.xml

# iOS - ignore everything except specific files
/ios/*
!/ios/Podfile                          # Keep Podfile for use_modular_headers customization
!/ios/Podfile.properties.json          # Keep Podfile properties
```

### How This Works

**Pattern explanation:**
```gitignore
/ios/*              # Ignore all files/folders in /ios
!/ios/Podfile       # EXCEPT Podfile (negation pattern)
```

**Important:** Once files are committed, the negation patterns work automatically. For initial setup, use `git add -f` to force-add ignored files.

---

## Initial Git Setup

### Step 1: Generate Native Files

```bash
# Generate iOS and Android folders
npx expo prebuild
```

### Step 2: Force Add Required Files

Since these files are in ignored directories, use `-f` flag:

```bash
# Add iOS files
git add -f ios/Podfile
git add -f ios/Podfile.properties.json

# Add Android files (if customized)
git add -f android/app/src/main/AndroidManifest.xml
git add -f android/app/src/debug/AndroidManifest.xml
```

### Step 3: Commit

```bash
git commit -m "Add native config files for Firebase notifications

- ios/Podfile: Contains use_modular_headers for Firebase
- ios/Podfile.properties.json: Build configuration
- Android manifests: Notification permissions"
```

---

## Future Modifications

Once files are committed, git will track changes normally:

```bash
# Edit Podfile
vim ios/Podfile

# Git will detect changes automatically
git status
# Shows: modified: ios/Podfile

# Commit changes
git add ios/Podfile
git commit -m "Update Podfile configuration"
```

No need for `-f` flag after initial commit!

---

## Why Not Commit Everything in /ios and /android?

### Problems with Committing Everything

❌ **Large repository size**
- Build artifacts, compiled code
- Dependencies from CocoaPods and Gradle
- Can be 100s of MBs

❌ **Merge conflicts**
- Every `expo prebuild` regenerates files
- Different team members might have slightly different generated code
- Causes unnecessary conflicts

❌ **Machine-specific paths**
- Some generated files contain absolute paths
- Won't work on other developers' machines

### Benefits of Our Approach

✅ **Small repository**
- Only track essential custom files
- Everything else regenerated by `expo prebuild`

✅ **No merge conflicts**
- Regenerated files aren't tracked
- Only custom configurations tracked

✅ **Consistent across team**
- Each developer runs `expo prebuild` locally
- Custom configs (Podfile, manifests) are shared

---

## Common Scenarios

### Scenario 1: New Team Member Onboarding

```bash
# Clone repository
git clone <repo>

# Install dependencies
bun install

# Generate native files
npx expo prebuild

# iOS Podfile will already have use_modular_headers!
# (because it's in git)

# Install CocoaPods dependencies
cd ios && pod install && cd ..

# Build
bun build:dev:ios
```

✅ **Works immediately!** No manual Podfile edits needed.

---

### Scenario 2: After Running expo prebuild

```bash
# Run prebuild (regenerates /ios and /android)
npx expo prebuild --clean

# Check what changed
git status

# You might see:
# modified: ios/Podfile
# modified: ios/Podfile.properties.json
```

**What to do:**
1. Check if changes are meaningful (e.g., Expo version updates)
2. If yes, commit them
3. If no (just formatting), you can discard or commit

**The key:** `use_modular_headers!` should still be there!

---

### Scenario 3: Updating Podfile

```bash
# Edit Podfile manually
vim ios/Podfile

# Add/modify something
# (e.g., adding a new pod or configuration)

# Git automatically tracks the change
git status
# Shows: modified: ios/Podfile

# Commit
git add ios/Podfile
git commit -m "Add custom pod configuration"
```

---

### Scenario 4: EAS Build

EAS builds use files from git repository:

```bash
# When you run
eas build --platform ios

# EAS will:
# 1. Clone your repository
# 2. Find ios/Podfile (from git)
# 3. Run pod install (uses your Podfile with use_modular_headers!)
# 4. Build successfully ✅
```

**Without Podfile in git:**
- EAS would generate a fresh Podfile
- Missing `use_modular_headers!`
- Firebase build would fail ❌

---

## Verification Commands

### Check if Files Are Tracked

```bash
# Check Podfile
git ls-files ios/Podfile
# Output: ios/Podfile (means it's tracked)

# Check if file is ignored
git check-ignore ios/Podfile
# No output = not ignored ✅
# Shows path = ignored ❌
```

### See What's Committed

```bash
# List tracked files in ios/
git ls-files ios/

# Should show:
# ios/Podfile
# ios/Podfile.properties.json
```

### View Podfile from Git

```bash
# View committed version
git show HEAD:ios/Podfile

# Should include:
# use_modular_headers!
```

---

## Troubleshooting

### Issue: "Podfile changes not detected by git"

**Cause:** File is still being ignored

**Solution:**
```bash
# Force add once
git add -f ios/Podfile

# Commit
git commit -m "Add Podfile to git"

# Future changes will be tracked automatically
```

---

### Issue: "Merge conflict in Podfile"

**Cause:** Different versions of Expo or manual edits

**Solution:**
```bash
# Accept your changes (keep use_modular_headers!)
git checkout --ours ios/Podfile

# Or accept incoming changes and re-add use_modular_headers
git checkout --theirs ios/Podfile
# Then manually add: use_modular_headers!

# Mark as resolved
git add ios/Podfile
```

---

### Issue: "EAS build fails with Firebase module error"

**Error:**
```
The Swift pod 'FirebaseCoreInternal' depends upon 'GoogleUtilities',
which does not define modules.
```

**Cause:** Podfile in git is missing `use_modular_headers!`

**Solution:**
```bash
# Verify Podfile is committed
git ls-files ios/Podfile

# If not listed, force add it
git add -f ios/Podfile
git commit -m "Add Podfile with use_modular_headers"

# If listed, check it contains use_modular_headers
git show HEAD:ios/Podfile | grep use_modular_headers
```

---

## Best Practices

### 1. Always Review Podfile Changes

When `expo prebuild` modifies Podfile:

```bash
git diff ios/Podfile
```

**Look for:**
- ✅ `use_modular_headers!` still present
- ⚠️ Version updates (e.g., platform version changed)
- ⚠️ New dependencies added by Expo

### 2. Document Custom Changes

Add comments in Podfile:

```ruby
# Custom modification for Firebase compatibility
use_modular_headers!
```

### 3. Keep Podfile Minimal

Don't add unnecessary custom pods unless required. Let Expo manage most dependencies.

### 4. Test After Prebuild

After running `expo prebuild --clean`:

```bash
cd ios
pod install
cd ..

# Verify build still works
bun build:dev:ios
```

---

## Summary

**Files in Git:**
- ✅ `ios/Podfile` (has `use_modular_headers!`)
- ✅ `ios/Podfile.properties.json` (build config)
- ✅ `android/app/src/main/AndroidManifest.xml` (permissions)
- ✅ `android/app/src/debug/AndroidManifest.xml` (debug config)

**Why This Matters:**
- Firebase requires `use_modular_headers!` in Podfile
- Without it, iOS builds fail
- `expo prebuild` doesn't add it automatically
- Keeping it in git ensures it's always there

**Team Benefits:**
- New developers get correct setup immediately
- EAS builds work without manual intervention
- No "works on my machine" issues

---

**Last Updated**: 2025-01-31
